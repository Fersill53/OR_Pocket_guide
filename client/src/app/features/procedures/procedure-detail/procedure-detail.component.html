<!--
<section class="detail-page" *ngIf="(procedure$ | async) as p; else loading">
  <a routerLink="/procedures" class="back">← Back</a>

  <div class="header-row" style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1 *ngIf="!editMode">{{ p.name }}</h1>
      <div *ngIf="editMode">
        <input [(ngModel)]="editable!.name" />
      </div>
      <p class="meta">{{ p.service }} • {{ p.position || '—' }} • {{ p.anesthesia || '—' }}</p>
    </div>

    <div>
      <button *ngIf="!editMode" class="btn" (click)="startEdit(p)">Edit</button>
      <span *ngIf="editMode">
        <button class="btn" (click)="saveEdit()">Save</button>
        <button class="btn" (click)="cancelEdit()">Cancel</button>
      </span>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3>Room Setup</h3>
      <ul *ngIf="!editMode">
        <li *ngFor="let r of p.roomSetup">{{ r }}</li>
      </ul>

      <div *ngIf="editMode">
        <div *ngFor="let r of editable!.roomSetup ?? []; let i = index" class="edit-row">
          <input [(ngModel)]="editable!.roomSetup![i]" />
        </div>
        <button class="btn" (click)="editable!.roomSetup = (editable!.roomSetup ?? []).concat(['New item'])">Add</button>
      </div>
    </div>

    <div class="panel">
      <h3>Instruments</h3>

      <ul *ngIf="!editMode">
        <li *ngFor="let i of p.instruments">{{ i.name }} <small *ngIf="i.qty">×{{ i.qty }}</small></li>
      </ul>

      <div *ngIf="editMode">
        <div *ngFor="let it of editable!.instruments ?? []; let idx = index" class="edit-row">
          <input [(ngModel)]="editable!.instruments![idx].name" />
          <input type="number" style="width:80px" [(ngModel)]="editable!.instruments![idx].qty" />
          <button class="btn" (click)="removeInstrument(idx)">Remove</button>
        </div>

        <div style="margin-top:8px;">
          <button class="btn" (click)="addInstrument()">Add instrument</button>
        </div>
      </div>
    </div>

    <div class="panel" *ngIf="(p.supplies?.length || editable?.supplies?.length)">
      <h3>Supplies</h3>
      <ul *ngIf="!editMode">
        <li *ngFor="let s of p.supplies">{{ s.name }} <small *ngIf="s.qty">×{{ s.qty }}</small></li>
      </ul>
      <div *ngIf="editMode">
        <div *ngFor="let s of editable!.supplies ?? []; let i = index" class="edit-row">
          <input [(ngModel)]="editable!.supplies![i].name" />
          <input type="number" style="width:80px" [(ngModel)]="editable!.supplies![i].qty" />
        </div>
        <button class="btn" (click)="editable!.supplies = (editable!.supplies ?? []).concat([{name:'New supply'}])">Add</button>
      </div>
    </div>

    <div class="panel" *ngIf="(p.medications?.length || editable?.medications?.length)">
      <h3>Medications</h3>
      <ul *ngIf="!editMode">
        <li *ngFor="let m of p.medications">{{ m.name }} <small *ngIf="m.notes">— {{ m.notes }}</small></li>
      </ul>

      <div *ngIf="editMode">
        <div *ngFor="let m of editable!.medications ?? []; let i = index" class="edit-row">
          <input [(ngModel)]="editable!.medications![i].name" />
          <input [(ngModel)]="editable!.medications![i].notes" placeholder="notes" />
        </div>
        <button class="btn" (click)="editable!.medications = (editable!.medications ?? []).concat([{name:'New med'}])">Add</button>
      </div>
    </div>

    <div class="panel" *ngIf="(p.sutures?.length || editable?.sutures?.length)">
      <h3>Sutures</h3>
      <ul *ngIf="!editMode">
        <li *ngFor="let s of p.sutures">{{ s.name }}</li>
      </ul>

      <div *ngIf="editMode">
        <div *ngFor="let s of editable!.sutures ?? []; let i = index" class="edit-row">
          <input [(ngModel)]="editable!.sutures![i].name" />
        </div>
        <button class="btn" (click)="editable!.sutures = (editable!.sutures ?? []).concat([{name:'New suture'}])">Add</button>
      </div>
    </div>

    <div class="panel" *ngIf="(p.notes?.length || editable?.notes?.length)">
      <h3>Notes</h3>

      <ul *ngIf="!editMode">
        <li *ngFor="let n of p.notes">{{ n }}</li>
      </ul>

      <div *ngIf="editMode">
        <div *ngFor="let n of editable!.notes ?? []; let i = index" class="edit-row">
          <input [(ngModel)]="editable!.notes![i]" />
        </div>
        <button class="btn" (click)="editable!.notes = (editable!.notes ?? []).concat([''])">Add</button>
      </div>
    </div>
  </div>
</section>

<ng-template #loading>
  <div class="loading">Loading procedure…</div>
</ng-template>
--

<div class="page">
  <ng-container *ngIf="procedure$ | async as procedure">
    
    <!-- HEADER --
    <h1>{{ procedure.name }}</h1>

    <!-- ACTION BUTTONS --
    <div class="actions">
      <button class="btn primary" (click)="startEdit(procedure)">
        Edit
      </button>

      <button class="btn danger" (click)="confirmDelete(procedure)">
        Delete
      </button>

      <button class="btn" routerLink="/procedures">
        Back
      </button>
    </div>

    <!-- VIEW MODE --
    <div *ngIf="!editMode">
      <p><strong>Service:</strong> {{ procedure.service }}</p>

      <h3>Instruments</h3>
      <ul>
        <li *ngFor="let inst of procedure.instruments">{{ inst.name }}</li>
      </ul>

      <h3>Notes</h3>
      <ul>
        <li *ngFor="let n of procedure.notes">{{ n }}</li>
      </ul>
    </div>

    <!-- EDIT MODE --
    <div *ngIf="editMode">
      <!-- Your existing edit form stuff here --
      <button class="btn primary" (click)="saveEdit()">Save</button>
      <button class="btn" (click)="cancelEdit()">Cancel</button>
    </div>

  </ng-container>
</div>
-->

<!-- If procedure exists -->
<div class="page" *ngIf="procedure$ | async as p; else notFound">

  <!-- HEADER: title + actions -->
  <header class="page-header">
    <div class="title-block">
      <h1>{{ p.name }}</h1>
      <p class="subtitle">
        <strong>Service:</strong> {{ p.service }}
        <span *ngIf="p.position"> · <strong>Position:</strong> {{ p.position }}</span>
      </p>

      <div class="tags" *ngIf="p.tags?.length">
        <span class="tag" *ngFor="let t of p.tags">{{ t }}</span>
      </div>
    </div>

    <div class="actions">
      <!-- View mode actions -->
      <button
        class="btn primary"
        *ngIf="!editMode"
        (click)="startEdit(p)">
        Edit
      </button>

      <!-- Edit mode actions -->
      <ng-container *ngIf="editMode && editable as e">
        <button class="btn primary" (click)="saveEdit()">
          Save
        </button>
        <button class="btn" (click)="cancelEdit()">
          Cancel
        </button>
      </ng-container>

      <!-- Delete always available when we have a procedure -->
      <button
        class="btn danger"
        (click)="confirmDelete(p)">
        Delete
      </button>

      <button class="btn" routerLink="/procedures">
        Back
      </button>
    </div>
  </header>

  <!-- ===== VIEW MODE (read-only squares) ===== -->
  <div class="panel-grid" *ngIf="!editMode">

    <!-- Room Setup -->
    <section class="panel" *ngIf="p.roomSetup?.length">
      <h2>Room Setup</h2>
      <ul>
        <li *ngFor="let item of p.roomSetup">{{ item }}</li>
      </ul>
    </section>

    <!-- Drapes -->
    <section class="panel" *ngIf="p.drapes?.length">
      <h2>Drapes</h2>
      <ul>
        <li *ngFor="let item of p.drapes">{{ item }}</li>
      </ul>
    </section>

    <!-- Instruments -->
    <section class="panel" *ngIf="p.instruments?.length">
      <h2>Instruments</h2>
      <ul>
        <li *ngFor="let inst of p.instruments">
          {{ inst.name }}
        </li>
      </ul>
    </section>

    <!-- Supplies -->
    <section class="panel" *ngIf="p.supplies?.length">
      <h2>Supplies</h2>
      <ul>
        <li *ngFor="let s of p.supplies">
          {{ s.name }}
        </li>
      </ul>
    </section>

    <!-- Medications -->
    <section class="panel" *ngIf="p.medications?.length">
      <h2>Medications</h2>
      <ul>
        <li *ngFor="let m of p.medications">
          <strong>{{ m.name }}</strong>
          <span *ngIf="m.dose"> · {{ m.dose }}</span>
          <span *ngIf="m.route"> · {{ m.route }}</span>
        </li>
      </ul>
    </section>

    <!-- Sutures -->
    <section class="panel" *ngIf="p.sutures?.length">
      <h2>Sutures</h2>
      <ul>
        <li *ngFor="let s of p.sutures">
          <strong>{{ s.name }}</strong>
          <span *ngIf="s.size"> · {{ s.size }}</span>
        </li>
      </ul>
    </section>

    <!-- Dressings -->
    <section class="panel" *ngIf="p.dressings?.length">
      <h2>Dressings</h2>
      <ul>
        <li *ngFor="let d of p.dressings">
          {{ d }}
        </li>
      </ul>
    </section>

    <!-- Notes -->
    <section class="panel" *ngIf="p.notes?.length">
      <h2>Notes</h2>
      <ul>
        <li *ngFor="let n of p.notes">
          {{ n }}
        </li>
      </ul>
    </section>
  </div>

  <!-- ===== EDIT MODE (inline editable squares) ===== -->
  <div class="panel-grid" *ngIf="editMode && editable as e">

    <!-- Core Info -->
    <section class="panel">
      <h2>Core Info</h2>
      <label>
        Name
        <input
          type="text"
          [(ngModel)]="e.name"
          name="name" />
      </label>

      <label>
        Service
        <input
          type="text"
          [(ngModel)]="e.service"
          name="service" />
      </label>

      <label>
        Position
        <input
          type="text"
          [(ngModel)]="e.position"
          name="position" />
      </label>

      <label>
        Tags (comma separated)
        <input
          type="text"
          [ngModel]="e.tags?.join(', ')"
          (ngModelChange)="e.tags = ($event || '').split(',').map(t => t.trim()).filter(Boolean)"
          name="tagsText" />
      </label>
    </section>

    <!-- Room Setup -->
    <section class="panel">
      <h2>Room Setup</h2>
      <textarea
        rows="4"
        [ngModel]="e.roomSetup?.join('\n')"
        (ngModelChange)="e.roomSetup = ($event || '').split('\n').map(l => l.trim()).filter(Boolean)"
        name="roomSetupText"></textarea>
    </section>

    <!-- Drapes -->
    <section class="panel">
      <h2>Drapes</h2>
      <textarea
        rows="4"
        [ngModel]="e.drapes?.join('\n')"
        (ngModelChange)="e.drapes = ($event || '').split('\n').map(l => l.trim()).filter(Boolean)"
        name="drapesText"></textarea>
    </section>

    <!-- Instruments -->
    <section class="panel">
      <h2>Instruments</h2>
      <ul>
        <li *ngFor="let inst of asArray(e.instruments); let i = index">
          <input
            type="text"
            [(ngModel)]="inst.name"
            [name]="'instrument_' + i" />
        </li>
      </ul>
      <button
        type="button"
        class="btn small"
        (click)="(e.instruments = e.instruments || []).push({ name: 'New instrument' })">
        + Add Instrument
      </button>
    </section>

    <!-- Supplies -->
    <section class="panel">
      <h2>Supplies</h2>
      <ul>
        <li *ngFor="let s of asArray(e.supplies); let i = index">
          <input
            type="text"
            [(ngModel)]="s.name"
            [name]="'supply_' + i" />
        </li>
      </ul>
      <button
        type="button"
        class="btn small"
        (click)="(e.supplies = e.supplies || []).push({ name: 'New supply' })">
        + Add Supply
      </button>
    </section>

    <!-- Medications -->
    <section class="panel">
      <h2>Medications</h2>
      <div
        class="row"
        *ngFor="let m of asArray(e.medications); let i = index">
        <input
          type="text"
          placeholder="Name"
          [(ngModel)]="m.name"
          [name]="'med_name_' + i" />
        <input
          type="text"
          placeholder="Dose"
          [(ngModel)]="m.dose"
          [name]="'med_dose_' + i" />
        <input
          type="text"
          placeholder="Route"
          [(ngModel)]="m.route"
          [name]="'med_route_' + i" />
      </div>
      <button
        type="button"
        class="btn small"
        (click)="(e.medications = e.medications || []).push({ name: 'New med', dose: '', route: '' })">
        + Add Medication
      </button>
    </section>

    <!-- Sutures -->
    <section class="panel">
      <h2>Sutures</h2>
      <div
        class="row"
        *ngFor="let s of asArray(e.sutures); let i = index">
        <input
          type="text"
          placeholder="Name"
          [(ngModel)]="s.name"
          [name]="'suture_name_' + i" />
        <input
          type="text"
          placeholder="Size"
          [(ngModel)]="s.size"
          [name]="'suture_size_' + i" />
      </div>
      <button
        type="button"
        class="btn small"
        (click)="(e.sutures = e.sutures || []).push({ name: 'New suture', size: '' })">
        + Add Suture
      </button>
    </section>

    <!-- Dressings -->
    <section class="panel">
      <h2>Dressings</h2>
      <textarea
        rows="4"
        [ngModel]="e.dressings?.join('\n')"
        (ngModelChange)="e.dressings = ($event || '').split('\n').map(l => l.trim()).filter(Boolean)"
        name="dressingsText"></textarea>
    </section>

    <!-- Notes -->
    <section class="panel">
      <h2>Notes</h2>
      <textarea
        rows="4"
        [ngModel]="e.notes?.join('\n')"
        (ngModelChange)="e.notes = ($event || '').split('\n').map(l => l.trim()).filter(Boolean)"
        name="notesText"></textarea>
    </section>
  </div>
</div>

<!-- If procedure is missing -->
<ng-template #notFound>
  <div class="page empty">
    <p>Procedure not found.</p>
    <button class="btn" routerLink="/procedures">Back to list</button>
  </div>
</ng-template>
